<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer - ucanduit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="iconoir.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="tools/tool-base.css">
    <link rel="stylesheet" href="tools/timer.css">
</head>
<body>
    <!-- Animated background circles -->
    <div class="animated-background" id="animated-background"></div>
    
    <div class="timer-window-container">
        <div class="timer-window-header">
            <h1 class="timer-window-title" id="timer-window-title">
                <i class="iconoir-timer"></i> Timer Options
            </h1>
            <div class="timer-status" id="timer-status">Ready</div>
        </div>

        <div class="timer-window-content">

            <!-- Timer Controls -->
            <div class="timer-controls-section">
                <div class="timer-control-row">
                    <button class="tool-btn primary" id="start-btn">
                        <i class="iconoir-play"></i> Start
                    </button>
                    <button class="tool-btn warning" id="pause-btn">
                        <i class="iconoir-pause"></i> Pause
                    </button>
                    <button class="tool-btn" id="reset-btn">
                        <i class="iconoir-refresh-double"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Duration Setting -->
            <div class="timer-duration-section">
                <h3>Duration</h3>
                <div class="duration-slider-container">
                    <input type="range" class="slider" id="duration-slider" 
                           min="1" max="120" value="25" step="1">
                    <div class="slider-labels">
                        <span>1 min</span>
                        <span>120 min</span>
                    </div>
                </div>
                <div class="duration-display" id="duration-display">25 minutes</div>
                
                <!-- Quick Presets -->
                <div class="timer-presets">
                    <h4>Quick Presets</h4>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-minutes="5">
                            <i class="iconoir-flash"></i> Quick<br><span>5 min</span>
                        </button>
                        <button class="preset-btn active" data-minutes="25">
                            <i class="iconoir-timer"></i> Pomodoro<br><span>25 min</span>
                        </button>
                        <button class="preset-btn" data-minutes="45">
                            <i class="iconoir-brain"></i> Focus<br><span>45 min</span>
                        </button>
                        <button class="preset-btn" data-minutes="15">
                            <i class="iconoir-coffee-cup"></i> Break<br><span>15 min</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="timer-stats-section">
                <h3>Today's Sessions</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="sessions-today">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-time-today">0</div>
                        <div class="stat-label">Minutes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="average-session">0</div>
                        <div class="stat-label">Avg Length</div>
                    </div>
                </div>
                
   

    <script type="module">
        import { createAnimatedBackground, getDefaultCircles } from './animated-background.js';

        let currentWindow;
        let timerData = {
            isRunning: false,
            totalSeconds: 25 * 60,
            remainingSeconds: 25 * 60,
            intervalId: null,
            sessions: []
        };

        async function initializeTimerWindow() {
            try {
                // Wait for Tauri APIs
                let attempts = 0;
                const maxAttempts = 50;
                
                while (attempts < maxAttempts) {
                    if (window.__TAURI__ && window.__TAURI__.window) {
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (attempts >= maxAttempts) {
                    console.warn('Tauri API not available, running in browser mode');
                }

                // Get current window reference
                if (window.__TAURI__) {
                    const { getCurrentWindow } = window.__TAURI__.window;
                    currentWindow = getCurrentWindow();
                    window.tauriWindow = currentWindow;
                }

                // Load timer data
                await loadTimerData();
                
                // Initialize UI
                bindEvents();
                updateDisplay();
                updateStats();
                
                updateStatus('Timer window ready');

                console.log('✅ Timer window initialization complete');

            } catch (error) {
                console.error('Error initializing timer window:', error);
                updateStatus('Error: ' + error.message);
            }
        }

        async function loadTimerData() {
            try {
                // First try to load from external file using Tauri
                if (window.__TAURI__ && window.__TAURI__.core) {
                    const fileData = await window.__TAURI__.core.invoke('read_json_file', {
                        filename: 'ucanduit-timer-sessions.json'
                    });
                    if (fileData && fileData.sessions) {
                        timerData.sessions = fileData.sessions;
                        console.log('✅ Timer sessions loaded from external file');
                        return;
                    }
                }
            } catch (error) {
                console.log('📁 No external timer file found, checking localStorage...');
            }
            
            try {
                // Fallback to localStorage
                const storedData = localStorage.getItem('ucanduit_timer_sessions');
                if (storedData) {
                    const data = JSON.parse(storedData);
                    timerData.sessions = data.sessions || [];
                    console.log('✅ Timer sessions loaded from localStorage');
                }
            } catch (error) {
                console.error('❌ Failed to load timer data:', error);
                timerData.sessions = [];
            }
        }

        async function saveTimerData() {
            const data = { sessions: timerData.sessions };
            
            try {
                if (window.__TAURI__ && window.__TAURI__.core) {
                    await window.__TAURI__.core.invoke('write_json_file', {
                        filename: 'ucanduit-timer-sessions.json',
                        data: data
                    });
                    console.log('✅ Timer sessions saved to external file');
                } else {
                    localStorage.setItem('ucanduit_timer_sessions', JSON.stringify(data));
                    console.log('✅ Timer sessions saved to localStorage');
                }
            } catch (error) {
                console.error('❌ Failed to save timer data:', error);
            }
        }

        function bindEvents() {
            // Control buttons
            document.getElementById('start-btn').addEventListener('click', startTimer);
            document.getElementById('pause-btn').addEventListener('click', pauseTimer);
            document.getElementById('reset-btn').addEventListener('click', resetTimer);

            // Duration slider
            const slider = document.getElementById('duration-slider');
            slider.addEventListener('input', (e) => {
                const minutes = parseInt(e.target.value);
                setDuration(minutes * 60);
                updateActivePreset(minutes);
            });

            // Preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const minutes = parseInt(btn.dataset.minutes);
                    setDuration(minutes * 60);
                    updateActivePreset(minutes);
                    
                    // Update slider
                    slider.value = minutes;
                });
            });
        }

        function updateActivePreset(minutes) {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.minutes) === minutes);
            });
        }

        function setDuration(seconds) {
            if (timerData.isRunning) return; // Can't change duration while running
            
            timerData.totalSeconds = seconds;
            timerData.remainingSeconds = seconds;
            updateDisplay();
            
            // Send duration change to main window
            sendMessageToMainWindow('timer-set-duration', { seconds });
        }

        function startTimer() {
            // Send message to main window to start timer
            sendMessageToMainWindow('timer-start');
            updateStatus('Start command sent');
        }

        function pauseTimer() {
            // Send message to main window to pause timer
            sendMessageToMainWindow('timer-pause');
            updateStatus('Pause command sent');
        }

        function resetTimer() {
            // Send message to main window to reset timer
            sendMessageToMainWindow('timer-reset');
            updateStatus('Reset command sent');
        }

        async function sendMessageToMainWindow(action, data = null) {
            try {
                if (window.__TAURI__ && window.__TAURI__.event) {
                    // Use Tauri events to communicate with main window
                    const { emit } = window.__TAURI__.event;
                    await emit('timer-window-action', { action, data });
                    console.log(`Sent ${action} to main window`);
                } else {
                    // Browser fallback - use localStorage for communication
                    const message = { action, data, timestamp: Date.now() };
                    localStorage.setItem('timer-window-message', JSON.stringify(message));
                    
                    // Dispatch event for main window to listen
                    window.dispatchEvent(new CustomEvent('timer-window-message', { detail: message }));
                }
            } catch (error) {
                console.error('Error sending message to main window:', error);
                updateStatus('Error: Could not communicate with main timer');
            }
        }

        async function completeTimer() {
            timerData.isRunning = false;
            if (timerData.intervalId) {
                clearInterval(timerData.intervalId);
                timerData.intervalId = null;
            }

            // Save completed session
            const session = {
                id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                startTime: timerData.startTime,
                endTime: Date.now(),
                duration: timerData.totalSeconds,
                completed: true,
                type: getSessionType(timerData.totalSeconds)
            };
            
            timerData.sessions.push(session);
            await saveTimerData();
            
            // Play completion sound
            playCompletionSound();
            
            updateStatus('🎉 Timer Complete!');
            updateStats();
            
            // Auto-reset after 3 seconds
            setTimeout(() => {
                resetTimer();
            }, 3000);
        }

        function getSessionType(seconds) {
            const minutes = Math.floor(seconds / 60);
            if (minutes === 25) return 'pomodoro';
            if (minutes === 5) return 'quick';
            if (minutes === 45) return 'focus';
            if (minutes === 15) return 'break';
            return 'custom';
        }

        function playCompletionSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5 chord
                
                frequencies.forEach((freq, i) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    const startTime = audioContext.currentTime + (i * 0.1);
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(0.1, startTime + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.8);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.8);
                });
            } catch (error) {
                console.log('Could not play completion sound:', error);
            }
        }

        function updateDisplay() {
            const durationDisplay = document.getElementById('duration-display');
            
            const minutes = Math.floor(timerData.totalSeconds / 60);
            durationDisplay.textContent = `${minutes} minute${minutes !== 1 ? 's' : ''}`;
        }

        function updateStatus(message) {
            const statusEl = document.getElementById('timer-status');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todaySessions = timerData.sessions.filter(session => {
                const sessionDate = new Date(session.startTime).toDateString();
                return sessionDate === today && session.completed;
            });

            // Update stats
            document.getElementById('sessions-today').textContent = todaySessions.length;
            
            const totalMinutes = todaySessions.reduce((sum, session) => 
                sum + Math.floor(session.duration / 60), 0);
            document.getElementById('total-time-today').textContent = totalMinutes;
            
            const avgSession = todaySessions.length > 0 ? 
                Math.round(totalMinutes / todaySessions.length) : 0;
            document.getElementById('average-session').textContent = avgSession;
            
            // Update recent sessions
            const sessionsList = document.getElementById('sessions-list');
            if (todaySessions.length === 0) {
                sessionsList.innerHTML = '<div class="no-sessions">No sessions today</div>';
            } else {
                const recentSessions = todaySessions.slice(-5).reverse();
                sessionsList.innerHTML = recentSessions.map(session => {
                    const startTime = new Date(session.startTime).toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    const duration = Math.floor(session.duration / 60);
                    return `
                        <div class="session-item">
                            <span class="session-time">${startTime}</span>
                            <span class="session-duration">${duration} min</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function initializeDarkMode() {
            try {
                const savedTheme = localStorage.getItem('ucanduit-theme');
                if (savedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            } catch (error) {
                console.log('Could not load theme preference:', error);
            }
        }

        function getSmallWindowCircles() {
            return [
                { x: 20, y: 20, size: 40, color: 'var(--udu-green)', duration: 15 },
                { x: 80, y: 60, size: 60, color: 'var(--candu-blue)', duration: 20 },
                { x: 60, y: 10, size: 30, color: 'var(--perfect-pink)', duration: 18 }
            ];
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            initializeDarkMode();
            createAnimatedBackground({ 
                containerId: 'animated-background',
                circles: getSmallWindowCircles()
            });
            initializeTimerWindow();
        });
    </script>
</body>
</html>